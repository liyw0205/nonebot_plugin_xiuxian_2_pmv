{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-sync-alt"></i> æ£€æµ‹æ›´æ–°</h2>
    
    <div id="update-status">
        <div class="loading">æ£€æŸ¥æ›´æ–°ä¸­...</div>
    </div>
    
    <div id="releases-list" style="display: none; margin-top: 20px;">
        <h3>æœ€è¿‘æ›´æ–°</h3>
        <div class="releases-container"></div>
    </div>
    
    <div class="form-actions">
        <button onclick="checkForUpdates()" class="btn btn-primary">
            <i class="fas fa-sync"></i> æ£€æŸ¥æ›´æ–°
        </button>
        <button onclick="viewAllReleases()" class="btn btn-info">
            <i class="fas fa-list"></i> æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬
        </button>
    </div>
</div>

<script>
async function checkForUpdates() {
    const statusDiv = document.getElementById('update-status');
    statusDiv.innerHTML = '<div class="loading">æ£€æŸ¥æ›´æ–°ä¸­...</div>';
    
    try {
        const response = await fetch('/check_update');
        const data = await response.json();
        
        if (data.success) {
            if (data.update_available) {
                statusDiv.innerHTML = `
                    <div class="update-available">
                        <h3 style="color: #4CAF50;">ğŸ‰ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼</h3>
                        <p>å½“å‰ç‰ˆæœ¬: ${data.current_version}</p>
                        <p>æœ€æ–°ç‰ˆæœ¬: <strong>${data.latest_version}</strong></p>
                        <p>å‘å¸ƒæ—¶é—´: ${new Date(data.published_at).toLocaleString()}</p>
                        <div class="changelog">
                            <h4>æ›´æ–°å†…å®¹:</h4>
                            <pre>${data.changelog}</pre>
                        </div>
                        <button onclick="performUpdate('${data.latest_version}')" class="btn btn-success">
                            <i class="fas fa-download"></i> ç«‹å³æ›´æ–°
                        </button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="no-update">
                        <h3 style="color: #666;">âœ… å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</h3>
                        <p>å½“å‰ç‰ˆæœ¬: ${data.current_version}</p>
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `<div class="error">âŒâŒ æ£€æŸ¥æ›´æ–°å¤±è´¥: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="error">âŒâŒ è¯·æ±‚å¤±è´¥: ${error}</div>`;
    }
}

async function viewAllReleases() {
    const releasesDiv = document.getElementById('releases-list');
    const container = releasesDiv.querySelector('.releases-container');
    container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    releasesDiv.style.display = 'block';
    
    try {
        const response = await fetch('/get_releases');
        const data = await response.json();
        
        if (data.success) {
            let html = '';
            data.releases.forEach(release => {
                const isCurrent = release.tag_name === data.current_version;
                html += `
                    <div class="release-card ${isCurrent ? 'current-release' : ''}">
                        <h4>${release.name} <span class="tag">${release.tag_name}</span></h4>
                        <p class="release-date">${new Date(release.published_at).toLocaleString()}</p>
                        <div class="release-notes">${release.body}</div>
                        ${!isCurrent ? `
                        <button onclick="performUpdate('${release.tag_name}')" class="btn btn-sm btn-success">
                            æ›´æ–°åˆ°æ­¤ç‰ˆæœ¬
                        </button>
                        ` : '<span class="current-badge">å½“å‰ç‰ˆæœ¬</span>'}
                    </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="error">è¯·æ±‚å¤±è´¥: ${error}</div>`;
    }
}

async function performUpdate(releaseTag) {
    if (!confirm(`ç¡®å®šè¦æ›´æ–°åˆ°ç‰ˆæœ¬ ${releaseTag} å—ï¼Ÿå»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚`)) {
        return;
    }
    
    const statusDiv = document.getElementById('update-status');
    statusDiv.innerHTML = '<div class="loading">æ›´æ–°ä¸­ï¼Œè¯·æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—...</div>';
    
    try {
        const response = await fetch('/perform_update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ release_tag: releaseTag })
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="success">
                    <h3 style="color: #4CAF50;">âœ… æ›´æ–°æˆåŠŸï¼</h3>
                    <p>${data.message}</p>
                    <p>è¯·é‡å¯æœºå™¨äººä½¿æ›´æ–°ç”Ÿæ•ˆ</p>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="error">
                    <h3 style="color: #F44336;">âŒâŒ æ›´æ–°å¤±è´¥</h3>
                    <p>${data.message}</p>
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="error">
                <h3 style="color: #F44336;">âŒâŒ æ›´æ–°è¯·æ±‚å¤±è´¥</h3>
                <p>${error}</p>
            </div>
        `;
    }
}

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
document.addEventListener('DOMContentLoaded', function() {
    checkForUpdates();
});
</script>

<style>
.update-available, .no-update, .error {
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
}

.update-available {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border: 1px solid #4CAF50;
}

.no-update {
    background: #f5f5f5;
    border: 1px solid #ddd;
}

.error {
    background: #ffebee;
    border: 1px solid #F44336;
}

.changelog pre {
    background: white;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #ddd;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.release-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.release-card.current-release {
    border-color: #4CAF50;
    background: #e8f5e8;
}

.tag {
    background: #2196F3;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.current-badge {
    background: #4CAF50;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.9em;
}

.release-date {
    color: #666;
    font-size: 0.9em;
}

.release-notes {
    margin: 10px 0;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
    max-height: 100px;
    overflow-y: auto;
}
</style>
{% endblock %}
